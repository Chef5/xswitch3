(()=>{"use strict";const e={TRIM_JSON:/(,+)([^a-z0-9["])/gi,CHROME_EXTENSION:/^chrome-extension:\/\//i,FORWARD:/\\|\[|]|\(|\)|\*|\$|\^/i,WHITESPACE:/\s+/g,X_HEADER:/^x-/},t={METHODS:"access-control-allow-methods",CREDENTIALS:"access-control-allow-credentials",ORIGIN:"access-control-allow-origin",HEADERS:"access-control-allow-headers"},r="disabled",s="config",o="config_for_shown",n="tab_list",a="active_keys",i="clearCacheEnabled",c="cors",l="corsEnabled",u="proxy",d=!1,h="sync_storage_data_has_been_migarated_to_local",g="images/grey_128.png";var f,R,p,m,E;!function(e){e.REG="reg",e.STRING="string"}(f||(f={})),(E=R||(R={})).YES="enabled",E.NO="disabled",function(e){e.ON="#1890ff",e.OFF="#bfbfbf",e.ERROR="#f5222d"}(p||(p={})),function(e){e.ERROR="Error",e.OFF="OFF",e.ON="ON"}(m||(m={}));const _=(t,r)=>{if(e.FORWARD.test(r)){if(new RegExp(r.replace("??","\\?\\?"),"i").test(t))return f.REG}else if(t.indexOf(r)>-1)return f.STRING;return!1};let w=null;const O=(w||(w=new class{constructor(){this._lastRequestId=null,this._disabled=R.YES,this._config={},this._originRequest=new Map,this._originRequestHeaders=new Map,this._urls=new Array(200)}get urls(){return this._urls}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get config(){return this._config}set config(e){this._config=Object.assign({},e)}onHeadersReceivedCallback(e,r=!0){const s=this.config.cors;let o=!1;if(s&&s.length&&s.forEach(t=>{_(e.url,t)&&(o=!0)}),this.disabled===R.NO||!r||!o)return{};e.url;let n=[],a=(this._originRequest.get(e.requestId)?this._originRequest.get(e.requestId):e.initiator)||"*";if(e.responseHeaders&&e.responseHeaders.filter){let r=!1,s="";n=e.responseHeaders.filter(e=>(t.ORIGIN===e.name.toLowerCase()&&(s=e.value),t.CREDENTIALS===e.name.toLowerCase()&&(r=e.value),[t.ORIGIN,t.CREDENTIALS,t.METHODS,t.HEADERS].indexOf(e.name.toLowerCase())<0)),r&&(a=s)}"*"===a&&"null"===this._originRequest.get(e.requestId)&&(a="*"),n.push({name:t.ORIGIN,value:a}),n.push({name:t.CREDENTIALS,value:"true"}),n.push({name:t.METHODS,value:"*"});let i="";return this._originRequestHeaders.get(e.requestId)&&(i=","+this._originRequestHeaders.get(e.requestId)),n.push({name:t.HEADERS,value:"Content-Type, access-control-allow-headers, Authorization, X-Requested-With, X-Referer"+i}),{responseHeaders:n}}redirectToMatchingRule(t){const r=this.config.proxy;let s=t.url;if(!r||!r.length||e.CHROME_EXTENSION.test(s))return{};/http(s?):\/\/.*\.(js|css|json|jsonp)/.test(s)&&this._urls.indexOf(s)<0&&(this._urls.shift(),this._urls.push(s));try{for(let e=0;e<r.length;e++){const o=r[e];if(o&&o[0]&&"string"==typeof o[1]){const e=o[0],r=_(s,e);if(t.requestId!==this._lastRequestId)if(r===f.REG){const t=new RegExp(e.replace("??","\\?\\?"),"i");s=s.replace(t,o[1])}else r===f.STRING&&(s=s.split(o[0]).join(o[1]))}}}catch(e){console.error("rule match error",e)}return this._lastRequestId=t.requestId,s===t.url?{}:{redirectUrl:s}}onBeforeSendHeadersCallback(t){const r=[];for(let s=0;s<t.requestHeaders.length;++s){const o=t.requestHeaders[s].name.toLowerCase();"origin"===o?this._originRequest.set(t.requestId,t.requestHeaders[s].value):("access-control-request-headers"===o||e.X_HEADER.test(o))&&r.push(o)}return r.length&&this._originRequestHeaders.set(t.requestId,r.join(",")),{requestHeaders:t.requestHeaders}}onBeforeRequestCallback(e){return this.redirectToMatchingRule(e)}}),w);class y{constructor(e){this.storageFn=e.useChromeStorageSyncFn?chrome.storage.sync:chrome.storage.local}get(e,t){return new Promise((r,s)=>{this.storageFn.get(e,e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):(r(e),t&&t(e))})})}set(e,t){return new Promise((r,s)=>{this.storageFn.set(e,()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):(r(e),t&&t(e))})})}}const q=new y({useChromeStorageSyncFn:d});async function I(e,t){try{if(await async function(){try{const e=await async function(){try{return(await chrome.declarativeNetRequest.getDynamicRules()).map(e=>e.id)}catch(e){return console.error("Failed to get dynamic rules:",e),[]}}();e.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e})}catch(e){}}(),t)return;const r=function(e){const t=[];let r=1;return e.proxy&&e.proxy.length>0&&e.proxy.forEach((e,s)=>{if(e&&e[0]&&e[1]){const s=e[0],o=e[1],n=function(e){let t=e;return t=t.replace(/\./g,"\\.").replace(/-/g,"\\-"),t=t.replace(/\(\\\.\*\)/g,"(.*)"),t}(s),a=o.replace(/\$(\d+)/g,"\\$1");t.push({id:r++,priority:1,action:{type:"redirect",redirect:{regexSubstitution:a}},condition:{regexFilter:n,resourceTypes:["main_frame","sub_frame","stylesheet","script","image","font","object","xmlhttprequest","ping","csp_report","media","websocket","other"]}})}}),t}(e),s=function(e){const t=[];let r=1e3;return e.cors&&e.cors.length>0&&e.cors.forEach(e=>{t.push({id:r++,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:"access-control-allow-origin",operation:"set",value:"*"},{header:"access-control-allow-credentials",operation:"set",value:"true"},{header:"access-control-allow-methods",operation:"set",value:"*"},{header:"access-control-allow-headers",operation:"set",value:"Content-Type, access-control-allow-headers, Authorization, X-Requested-With, X-Referer"}]},condition:{urlFilter:`||${e}`,resourceTypes:["xmlhttprequest","websocket"]}})}),t}(e),o=[...r,...s];console.log("allRules---",o),o.length>0&&await chrome.declarativeNetRequest.updateDynamicRules({addRules:o}),console.log(`Updated declarativeNetRequest rules: ${o.length} rules`)}catch(e){console.error("Failed to update declarativeNetRequest rules:",e)}}function S(){return"undefined"!=typeof chrome&&void 0!==chrome.declarativeNetRequest}!function(){const e={[o]:{0:""},[s]:{},[n]:[{id:"0",name:"Current",active:!0}],[a]:["0"]},t={[h]:{migarated:!1}};q.get(t,t=>{t[h].migarated?console.log("SYNC_STORAGE_DATA_HAS_BEEN_MIGARATED_TO_LOCAL"):chrome.storage.sync.get(e,e=>{const t={[o]:{},[s]:{}};e[n].forEach(r=>{t[o][r.id]=e[o][r.id],t[s][r.id]=e[s][r.id]}),q.set(Object.assign(Object.assign({[h]:{migarated:!0}},e),t))})})}();const b=new y({useChromeStorageSyncFn:d});let N=!0,H=!0,v=!1,C=["0"],T={0:{[u]:[],[c]:[]}};function A(e){const t=[...C],r=e[0];return t.forEach(t=>{e[t]&&"0"!==t&&(e[t][u]&&(r[u]||(r[u]=[]),r[u]=[...r[u],...e[t][u]]),e[t][c]&&(r[c]||(r[c]=[]),r[c]=[...r[c],...e[t][c]]))}),r}function F(e,t){const r=chrome.action||chrome.browserAction;r.setBadgeText({text:""+e}),r.setBadgeBackgroundColor({color:t})}function D(){var e,t;v?F(m.ERROR,p.ERROR):O[r]!==R.NO?F((null===(t=null===(e=O[s])||void 0===e?void 0:e[u])||void 0===t?void 0:t.length)||0,p.ON):F(m.OFF,p.OFF)}function x(){const e=chrome.action||chrome.browserAction;try{if("undefined"!=typeof window&&window.matchMedia){const t=window.matchMedia("(prefers-color-scheme: dark)");t&&t.matches?e.setIcon({path:"images/blue_128.png"}):e.setIcon({path:g})}else e.setIcon({path:g})}catch(t){e.setIcon({path:g})}}b.get({[s]:{0:{[u]:[],[c]:[]}},[a]:["0"]},e=>{if(C=e[a],e&&e[s]){T=e[s];const t=A(T);O[s]=Object.assign({},t)}else O[s]={[u]:[],[c]:[]},v=!1}),b.get({[r]:R.YES,[i]:R.YES,[l]:R.YES},e=>{O[r]=e[r],N=e[i]===R.YES,H=e[l]===R.YES,D()}),chrome.storage.onChanged.addListener(e=>{if(e[a]&&(C=e[a].newValue),e[s]){const t=A(e[s].newValue);O[s]=Object.assign({},t)}e[r]&&(O[r]=e[r].newValue),e[i]&&(N=e[i].newValue===R.YES),e[l]&&(H=e[l].newValue===R.YES),b.get({[s]:{0:{[u]:[],[c]:[]}}},e=>{if(e&&e[s]){T=e[s];const t=A(T);O[s]=Object.assign({},t),S()&&I(t,O[r]===R.NO)}D()}),x()}),b.get({[s]:{0:{[u]:[],[c]:[]}}},async e=>{if(e&&e[s]){T=e[s];const t=A(T),o=await new Promise(e=>{q.get(r,t=>{e(t[r])})})===R.NO;S()&&I(t,o)}D()}),x()})();
//# sourceMappingURL=background.min.js.map